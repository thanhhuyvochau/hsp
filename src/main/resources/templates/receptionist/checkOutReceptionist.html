<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lễ tân</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
            integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
            integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
            crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
            crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.css"/>

    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.js"></script>
    <script src="https://kit.fontawesome.com/ae360af17e.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="/assets/css/manager.css"/>
    <link rel="stylesheet" href="/assets/css/sidebar.css">
    <script src="/assets/js/sidebar.js"></script>
    <script src="/assets/js/manager.js"></script>
    <link rel="stylesheet" href="/assets/css/header-footer.css">
    <link rel="stylesheet" href="/assets/css/header_footer_style.css">
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css'>

    <!-- Include Bootstrap-datepicker CSS -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">

    <!-- Include Bootstrap-datepicker JS -->
    <script
            src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <!-- Include Bootstrap-datepicker localization for Vietnamese -->
    <script
            src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/locales/bootstrap-datepicker.vi.min.js"></script>

    <style>
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(21, 20, 20, 0.7);
            justify-content: center;
            align-items: center;
            color: black;
        }

        .overlay h1 {
            text-align: center;
        }

        .overlay__content {
            width: 70%;
            position: sticky;
            top: 25%;
            /*box-shadow: 10px 10px 5px 0px rgba(0, 0, 0, 0.75);*/
            max-height: 500px;
        }

        .button-container {
            gap: 2rem;
            display: flex;
            justify-content: flex-end;
        }

        .button-container button {
            font-size: 14px;
            cursor: pointer;
            width: 120px;
            appearance: none;
            background-color: #2ea44f;
            border: 1px solid rgba(27, 31, 35, .15);
            border-radius: 6px;
            box-shadow: rgba(27, 31, 35, .1) 0 1px 0;
            box-sizing: border-box;
            color: #fff;
            display: inline-block;
            font-family: -apple-system, system-ui, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            font-weight: 600;
            line-height: 20px;
            padding: 6px 14px;
            position: relative;
            text-align: center;
            text-decoration: none;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            vertical-align: middle;
            white-space: nowrap;
        }

        .button-container button:focus:not(:focus-visible):not(.focus-visible) {
            box-shadow: none;
            outline: none;
        }

        .button-container button:hover {
            background-color: #2c974b;
        }

        .button-container button:focus {
            box-shadow: rgba(46, 164, 79, .4) 0 0 0 3px;
            outline: none;
        }

        .button-container button:disabled {
            background-color: #94d3a2;
            border-color: rgba(27, 31, 35, .1);
            color: rgba(255, 255, 255, .8);
            cursor: default;
        }

        .button-container button:active {
            background-color: #298e46;
            box-shadow: rgba(20, 70, 32, .2) 0 1px 0 inset;
        }

        .toast-custom {
            position: absolute;
            top: 25px;
            right: 30px;
            border-radius: 12px;
            background: #fff;
            padding: 20px 35px 20px 25px;
            box-shadow: 0 6px 20px -5px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transform: translateX(calc(100% + 30px));
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.35);
        }

        .toast-custom.active {
            transform: translateX(0%);
        }

        .toast-custom .toast-content {
            display: flex;
            align-items: center;
        }

        .toast-content .check {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 35px;
            min-width: 35px;
            background-color: #e71919;
            color: #fff;
            font-size: 20px;
            border-radius: 50%;
        }

        .toast-content .message {
            display: flex;
            flex-direction: column;
            margin: 0 20px;
        }

        .message .text {
            font-size: 16px;
            font-weight: 400;
            color: #666666;
        }

        .message .text.text-1 {
            font-weight: 600;
            color: #333;
        }

        .toast-custom .close {
            position: absolute;
            top: 10px;
            right: 15px;
            padding: 5px;
            cursor: pointer;
            opacity: 0.7;
        }

        .toast-custom .close:hover {
            opacity: 1;
        }

        .toast-custom .progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            width: 100%;

        }

        .toast-custom .progress:before {
            content: "";
            position: absolute;
            bottom: 0;
            right: 0;
            height: 100%;
            width: 100%;
            background-color: green;
        }

        .progress.active:before {
            animation: progress 5s linear forwards;
        }

        @keyframes progress {
            100% {
                right: 100%;
            }
        }

    </style>
</head>

<body>

<!--	<body data-bs-target=".navbar" data-bs-offset="100"></body>-->
<form id="checkout-form" th:action="@{/receptionist/checkOutReceptionist}" method="post" th:object="${saveCheckoutDTO}"
      class="wrapper">
    <!-- Sidebar Holder -->
    <nav id="sidebar">
        <div class="sidebar-header border-bottom">
            <img src="/assets/img/Orilogo.png" class="img-fluid">
        </div>

        <ul class="list-unstyled components border-bottom">
            <p class="border-bottom fw-bold"><i class="bi bi-person-badge-fill pe-2"></i>Lễ tân</p>
            <li>
                <a href="#"><i class="fa-regular fa-rectangle-list pe-2"></i>Danh sách phòng</a>
            </li>
            <li>
                <a href="./createRoomReceptionist"><i class="fa-solid fa-check-double pe-2"></i>Đặt phòng</a>
            </li>
            <li>
                <a href="./checkOutReceptionist"><i class="fa-solid fa-right-from-bracket pe-2"></i>Trả phòng</a>
            </li>
            <li>
                <a href="./listRoomInUse"><i class="fa-solid fa-house-user pe-2"></i>Phòng đang sử dụng</a>
            </li>
            <li>
                <a href="./listBookingReceptionist"><i class="fa-solid fa-bell pe-2"></i>Đặt trước</a>
            </li>
            <li>
                <a href="./listHistoryBooking"><i class="fa-solid fa-clipboard pe-2"></i>Lịch sử đặt phòng</a>
            </li>
        </ul>

    </nav>

    <!-- Page Content Holder -->
    <div id="content">

        <nav class="navbar navbar-expand-lg shadow ">
            <div class="container-fluid">

                <button type="button" id="sidebarCollapse" class="navbar-btn">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <button class="btn btn-dark d-inline-block d-lg-none ml-auto" type="button" data-toggle="collapse"
                        data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                        aria-expanded="false" aria-label="Toggle navigation">
                    <i class="fas fa-align-justify"></i>
                </button>


                <button type="button" class=" btn bi-person-circle " style="font-size: 2em;"></button>
            </div>
        </nav>
        <main class="content px-3 py-2">
            <div class="container">
                <div class="row mt-3">
                    <h3 class="fw-bold text-center">Check-out</h3>
                    <hr>
                    <div class="row">
                        <h4 class="fw-bold">Khách hàng:</h4>
                    </div>
                    <div class="row ms-2 mb-3 border shadow">
                        <div class="col-lg-8">
                            <div class="row me-5">
                                <div class="col ms-2 mt-2">
                                    <h6 class="fw-bold">Họ tên: <a th:text="${viewCheckoutDTO.getName()}"></a></h6>
                                </div>
                            </div>
                            <div class="row mt-2 me-5">
                                <div class="col  ms-2">
                                    <h6 class="fw-bold">Số điện thoại: <a th:text="${viewCheckoutDTO.getPhone()}"></a>
                                    </h6>
                                </div>
                            </div>
                            <div class="row mt-2 me-5">
                                <div class="col  ms-2">
                                    <h6 class="fw-bold">Địa chỉ: <a th:text="${viewCheckoutDTO.getAddress()}"></a></h6>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 ">
                            <div class="row me-5 mt-2">
                                <h6 class="fw-bold">Email: <a th:text="${viewCheckoutDTO.getEmail()}"></a></h6>
                            </div>
                            <div class="row mt-2 me-5">
                                <h6 class="fw-bold">Ghi chú: <a th:text="${viewCheckoutDTO.getNote()}">Không</a></h6>
                            </div>
                            <div class="row mt-2 me-5">
                                <h6 class="fw-bold">Phương thức đặt: <a
                                        th:text="${viewCheckoutDTO.paymentTypeName}"></a></h6>
                            </div>
                        </div>
                    </div>
                    <h4 class="fw-bold mt-3">Thông tin phòng & dịch vụ:</h4>
                    <h6 class=" ms-2 mt-2">Mã đặt phòng: <a th:text="${viewCheckoutDTO.getHotelBookingId()}"></a>
                    </h6>
                </div>
                <div class="row mt-3 ms-1 me-3 border shadow">
                    <div class="col-lg-6 mt-3">
                        <p class="fw-bold">Ngày nhận phòng: <a th:text="${viewCheckoutDTO.getCheckIn()}"></a></p>
                    </div>
                    <div class="col-lg-6 mt-3">
                        <p class="fw-bold text-end">Ngày trả phòng đã đặt: <a
                                th:text="${viewCheckoutDTO.getCheckOutBooking()}"></a>
                        </p>
                        <p class="fw-bold text-end">Ngày trả phòng thực tế: <a
                                th:text="${viewCheckoutDTO.getCheckOut()}"></a>
                        </p>
                    </div>
                </div>

                <div class="row mt-5 me-1">
                    <div class="d-flex flex-column">
                        <table class="table table-striped table-hover border align-baseline text-center shadow">
                            <thead class="table-dark">
                            <tr>
                                <th scope="col">STT</th>
                                <th scope="col">Loại phòng</th>
                                <th scope="col">Số phòng đặt</th>
                                <th scope="col">Số khách</th>
                                <th scope="col">Ưu đãi</th>
                                <th scope="col">Chi tiết</th>
                                <th scope="col">Giá phòng</th>
                                <th scope="col">Tổng giá</th>
                                <th scope="col"></th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="bookDetail, iStat : ${viewCheckoutDTO.getBookingDetails()}">
                                <th scope="row" th:text="${iStat.index + 1}"></th>
                                <td th:text="${bookDetail.getCategoryName()}"></td>
                                <td th:text="${bookDetail.getRoomNumber()}">2</td>
                                <td th:text="${bookDetail.getCustomerNumber()}"></td>
                                <td>Bữa sáng</td>
                                <td>Không</td>
                                <td th:text="${#numbers.formatDecimal(bookDetail.getPrice(), 0, 'COMMA', 0, 'POINT')+ ' VND'}"></td>
                                <td th:text="${#numbers.formatDecimal(bookDetail.getTotalPrice(), 0, 'COMMA', 0, 'POINT')+ ' VND'}"></td>
                                <td></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="row ms-1">
                        <h4 class="fw-bold">Dịch vụ đang dùng:</h4>
                    </div>
                    <div class="d-flex flex-column">
                        <table id="use-service-table"
                               class="table table-striped table-hover border align-baseline text-center">
                            <thead class="table-dark">
                            <tr>
                                <th scope="col">STT</th>
                                <th scope="col">Tên dịch vụ</th>
                                <th scope="col">Số lượng</th>
                                <th scope="col">Đơn giá</th>
                                <th scope="col">Thành tiền</th>
                                <th scope="col"></th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="bookDetail, iStat : ${viewCheckoutDTO.getRoomBookingServiceDTOS()}">
                                <th scope="row" th:text="${iStat.index + 1 }"></th>
                                <td th:text="${bookDetail.getServiceName()}"></td>
                                <td th:text="${bookDetail.getQuantity()}"></td>
                                <td th:text="${bookDetail.getServicePrice()} + ' VND'"></td>
                                <td th:text="${bookDetail.getTotalPrice()} + ' VND'"></td>
                                <td>
                                    <button th:id="'delete-btn-service-'+${bookDetail.getServiceId()}" type="button"
                                            th:onclick="'deleteRow(\'' + ${bookDetail.getServiceId()} + '\');'"
                                            class="btn button btn-dark"><i class="bi bi-trash"></i></button>
                                </td>
                            </tr>
                            </tbody>
                            <tfoot>
                            <tr>
                                <th scope="row"></th>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td>
                                    <button type="button" id="openButton" class="btn btn-dark">Thêm</button>
                                </td>
                            </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <div class="row mt-4 me-2">
                    <div class="row ms-1">
                        <h4 class="fw-bold">Thanh toán:</h4>
                    </div>
                    <div class="row ms-1">
                        <div class="col-lg-12 border shadow">
                            <div class="row me-4 mt-2">
                                <div class="col ms-4">
                                    <h6 class="fw-bold">Giá phòng:</h6>
                                </div>
                                <div class="col text-end"><a id="room-price"
                                                             th:text="${#numbers.formatDecimal(viewCheckoutDTO.getTotalRoomPrice(), 0, 'COMMA', 0, 'POINT')} + ' VND'"></a>
                                </div>
                            </div>
                            <div class="row me-4 mt-2">
                                <div class="col ms-4">
                                    <h6 class="fw-bold">Giá dịch vụ:</h6>
                                </div>
                                <div class="col text-end"><a id="service-price"
                                                             th:text="${viewCheckoutDTO.getTotalServicePrice()}"></a>
                                </div>
                            </div>
                            <div class="row me-4 mt-2">
                                <div class="col ms-4">
                                    <h6 class="fw-bold mt-2">Phụ phí(nếu có):</h6>
                                </div>
                                <div class="d-flex justify-content-end w-25 mt-1"><input pattern="^\d+(\.\d{1,2})?$"
                                                                                         type="text"
                                                                                         id="surcharge-price"
                                                                                         th:field="*{surcharge}"
                                                                                         class="form-control w-50 mb-4 text-end">
                                </div>
                            </div>
                            <div class="row me-4">
                                <div class="col ms-4">
                                    <h6 class="fw-bold">Thuế(10%):</h6>
                                </div>
                                <div class="col text-end"><a id="tax-price"></a></div>
                            </div>
                            <div class="row mt-2 me-4">
                                <div class="col ms-4">
                                    <h6 class="fw-bold">Tổng giá:</h6>
                                </div>
                                <div class="col text-end"><a id="total-price"></a></div>
                            </div>
                            <div class="row mt-2 me-4">
                                <div class="col ms-4">
                                    <h6 class="fw-bold">Đã thanh toán:</h6>
                                </div>
                                <div class="col text-end"><a id="prepay-price"
                                                             th:text="${#numbers.formatDecimal(viewCheckoutDTO.getPrepay(), 0,'COMMA', 0, 'POINT')}"></a>
                                </div>
                                <input type="hidden" th:value="${viewCheckoutDTO.getPrepay()}"
                                       id="prepay-price-hidden"/>
                            </div>
                            <div class="row mt-2 me-4">
                                <div class="col ms-4">
                                    <h6 class="fw-bold">Hoàn tiền:</h6>
                                </div>
                                <div class="col text-end"><span id="refund-price" class="fw-bold"></span>
                                </div>
                            </div>
                            <div class="row mt-2 me-4">
                                <div class="col ms-4">
                                    <h6 class="fw-bold">Còn lại:</h6>
                                </div>
                                <div class="col text-end"><span id="remain-price" class="fw-bold"></span>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col ms-4">
                                    <h6 class="fw-bold">Phương thức đặt:</h6>
                                </div>
                                <div class="col text-end"><select th:field="*{paymentTypeId}" class="form-select">
                                    <option value="1" selected>Qua cổng thanh toán</option>
                                    <option value="2">Tiền mặt</option>
                                    <option value="3">Chuyển khoản</option>
                                </select></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-5">
                    <div class="btn-end text-center">
                        <!-- Sử dụng lớp 'text-center' để căn giữa nút -->
                        <button type="button" class="btn btn-secondary"
                                style="margin-right: 2rem; margin-top: 2rem; margin-bottom: 2rem;"><a
                                th:href="@{/receptionist/listRoomInUse}">Quay
                            lại</a>
                        </button>
                        <button onclick="handleOnClickCheckout()" type="button" class="btn btn-dark" style="margin-right: 2rem; margin-top:
                                2rem;margin-bottom: 2rem;">Check-out
                        </button>
                    </div>
                </div>
            </div>
            <div id="overlay" class="overlay">
                <div class="overlay__content" role="dialog">
                    <table id="service-table" class="table">
                        <thead>
                        <tr>
                            <th>STT</th>
                            <th>Tên dịch vụ</th>
                            <th>Đơn giá</th>
                            <th>Số lượng</th>
                            <th></th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody id="service-data">
                        <tr th:id="${'service-row-'+service.getServiceId()}" th:each="service, iStat : ${roomServices}">
                            <td th:text="${iStat.index + 1}"></td>
                            <td th:id="${'service-name-'+service.getServiceId()}"
                                th:text="${service.getServiceName()}"></td>
                            <td th:id="${'service-price-'+service.getServiceId()}"
                                th:text="${#numbers.formatDecimal(service.getServicePrice(), 0, 'COMMA', 0, 'POINT') + 'VND'}"></td>

                            <td>
                                <label>
                                    <input min="0" value="0" th:id="${'service-quantity-'+service.getServiceId()}"
                                           type="number">
                                </label>
                            </td>
                            <td id="">
                                <button type="button"
                                        th:onclick="'addHotelService(\'' + ${service.getServiceId()} + '\');'"
                                        class="btn btn-danger">Thêm
                                </button>
                            </td>
                            <td>
                                <input type="hidden" th:id="${'service-id-'+iStat.index}"
                                       th:value="${service.getServiceId()}">
                            </td>
                        </tr>
                        <!-- Add more data rows as needed -->
                        </tbody>
                    </table>
                    <div class="button-container">
                        <button type="button" id="confirm-overlay-btn">Đóng</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <input type="hidden" th:value="${viewCheckoutDTO.getHotelBookingId()}" name="hotelBookingId" id="hotelBookingId">
    <div id="service-used-container">
        <div th:id="'service-'+${useService.getServiceId()}"
             th:each="useService, iterStat : ${viewCheckoutDTO.getRoomBookingServiceDTOS()}">
            <h1 th:text="${iterStat.index}"></h1>
            <input th:id="'serviceInputID-'+${useService.getServiceId()}" th:value="${useService.getServiceId()}"
                   type="hidden"
                   th:field="*{hotelServices[__${iterStat.index}__].serviceId}">
            <input th:id="'serviceInputQuantity-'+${useService.getServiceId()}" th:value="${useService.getQuantity()}"
                   type="hidden"
                   th:field="*{hotelServices[__${iterStat.index}__].quantity}">
        </div>
    </div>
</form>


<div class="toast-custom">

    <div class="toast-content">
        <i class="fas fa-solid fa-x check"></i>

        <div class="message">
            <span class="text text-1 " id="toast-title">Success</span>
            <span class="text text-2 " id="toast-detail">Your changes has been saved</span>
        </div>
    </div>
    <i class="fa-solid fa-xmark close"></i>

    <!-- Remove 'active' class, this is just to show in Codepen thumbnail -->
    <div class="progress active"></div>
</div>
</body>


<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.9.2/umd/popper.min.js"></script>
<script src="https://kit.fontawesome.com/032d11eac3.js" crossorigin="anonymous"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    let services = [[${roomServices}]];
    let addedServices = [[${viewCheckoutDTO.getRoomBookingServiceDTOS()}]];
    let roomPrice = [[${viewCheckoutDTO.getTotalRoomPrice()}]];

    /*]]>*/


    function addHotelService(serviceId) {
        let $quantity = $('#service-quantity-' + serviceId);
        let quantity = $quantity.val();
        // let $serviceID = $('#service-id-' + rowID);
        // let serviceId = $serviceID.val();
        let container = document.getElementById('service-used-container');
        let index = container.children.length; // Get the current index

        if (quantity > 0) {

            let serviceIndex = addedServices.findIndex(service => service.serviceId == serviceId);
            console.log("INDEX:" + serviceIndex)
            ;
            if (serviceIndex < 0) {
                let addedService = services.find(service => service.serviceId == serviceId);

                addedServices.push({...addedService, quantity});
                let detailDiv = document.createElement('div');
                detailDiv.id = `service-${serviceId}`;
                detailDiv.innerHTML = `
            <input id="serviceInputID-${serviceId}" value="${serviceId}" type="hidden"
                   name="hotelServices[${index}].serviceId">
            <input id="serviceInputQuantity-${serviceId}" value="${quantity}" type="hidden"
                   name="hotelServices[${index}].quantity">
        `;
                container.appendChild(detailDiv);
            } else {
                let addedService = addedServices[serviceIndex];
                addedService.quantity = Number(quantity);
                $("#serviceInputQuantity-" + serviceId).val(addedService.quantity);
            }
            updateUseServiceView();
        } else {
            triggerToast("Thất bại", "Không thể thêm dịch vụ nếu số lượng bằng không")
        }
    }

    function updateUseServiceView() {
        // Select the table body
        const tbody = $("#use-service-table > tbody");
        tbody.empty(); // clean old data
        var index = 1;

        console.log("LIST SERVICE:" + JSON.stringify(addedServices))

        addedServices.forEach(addService => {
            let row = $("<tr></tr>");
            row.id = 'input-service-id-' + addService.serviceId;
            row.append("<th scope='row'>" + index + "</th>");
            row.append("<td>" + addService.serviceName + "</td>");
            // Add other columns based on room properties

            // Example columns for demonstration, replace with actual data
            row.append("<td>" + addService.quantity + "</td>");
            row.append("<td>" + formatCurrency(addService.servicePrice) + "</td>");
            row.append("<td>" + formatCurrency(addService.servicePrice * addService.quantity) + "</td>");

            const buttonColumn = $("<td></td>");
            const trashButton = $("<button type='button'></button>")
                .addClass("btn button btn-dark")
                .html("<i class='bi bi-trash'></i>")
                .on("click", function () {
                    deleteRow(addService.serviceId);
                });
            trashButton.attr("id", "delete-btn-service-" + addService.serviceId);
            buttonColumn.append(trashButton);

            row.append(buttonColumn);
            // Append the row to the table body
            tbody.append(row);
            index++;
        });
        // Update the table with new data
        calculatePrices();
    }

    $(document).ready(function () {
        // Initialize DataTable

        $("#openButton").click(function () {
            console.log(services);
            $("#overlay").css("display", "flex");
        });

        $("#confirm-overlay-btn").click(function () {
            pattern = "[1-9]\d*|0\.\d+"
            $("#overlay").css("display", "none");
        });
        $("#close-overlay-btn").click(function () {
            $("#overlay").css("display", "none");
        });

        $(".modal-content").click(function (e) {
            e.stopPropagation(); // Prevent modal close on modal content click
        });

        $("#surcharge-price").change(function (e) {
            calculatePrices();
        });

        $('#surcharge-price').on('input', function () {
            var inputValue = $(this).val();
            // Use a regular expression to allow only positive numbers
            var isValid = /^\d*\.?\d+$/.test(inputValue);

            if (!isValid) {
                // If the input is not a valid number, clear the input field
                $(this).val('');
            }
        });
        calculatePrices();
    });

    function validateServicePrice() {
        let servicePrice = reCalculateServicePrice();
        if (Number(servicePrice) >= 1000000000) {
            triggerToast("Thất bại", "Dịch vụ không thể quá 1 tỷ VND, vui lòng giảm số lượng dịch vụ")
            return false;
        }
        return true;
    }

    function calculatePrices() {

        let $service = $("#service-price");
        let $surcharge = $("#surcharge-price");
        let $tax = $("#tax-price");
        let $total = $("#total-price");
        let $remain = $("#remain-price");
        let $prepay = $("#prepay-price-hidden");
        let $refund = $("#refund-price");
        let servicePrice = reCalculateServicePrice();
        let surchargePrice = $surcharge.val();
        let taxPrice = $tax.text();
        let totalPrice = $total.text();
        let remainPrice = $remain.text();
        let prepayPrice = $prepay.val();

        taxPrice = (Number(roomPrice) + Number(servicePrice) + Number(surchargePrice)) * 0.1;
        totalPrice = Number(roomPrice) + Number(servicePrice) + Number(surchargePrice) + Number(taxPrice);
        remainPrice = Number(totalPrice) - Number(prepayPrice);

        $tax.text(formatCurrency(taxPrice));
        $total.text(formatCurrency(totalPrice));
        if (remainPrice < 0) {
            $remain.text(formatCurrency(0));
            $refund.text(formatCurrency(remainPrice * -1));
        } else {
            $remain.text(formatCurrency(remainPrice));
            $refund.text(formatCurrency(0));
        }
        $service.text(formatCurrency(servicePrice));
    }

    function deleteRow(serviceId) {
        let button = $("#delete-btn-service-" + serviceId);
        let row = button.parent().parent();
        row.parent().remove(row);
        addedServices = addedServices.filter(service => service.serviceId != serviceId);
        deleteServiceInput(serviceId);
        updateUseServiceView();
    }

    function deleteServiceInput(serviceId) {
// Create the class name pattern
        var idServiceInput = 'service-' + serviceId;
// Select and remove all elements with the specified class name pattern
        var elementsToRemove = document.getElementById(idServiceInput);
        elementsToRemove.parentNode.removeChild(elementsToRemove);
    }

    function reCalculateServicePrice() {
        var table = document.getElementById('use-service-table');
        var total = 0;

        for (var i = 1; i < table.rows.length; i++) {
            let priceCell = table.rows[i].cells[3]; // Index 4 corresponds to the 'Thành tiền' column
            let numberFromVND = extractNumberFromVND(priceCell.textContent);
            console.log("PRICE CELL:" + numberFromVND);
            let quantityCell = table.rows[i].cells[2];
            // Parse the priceCell content as a float and add it to the total
            let price = numberFromVND * Number(quantityCell.textContent || quantityCell.innerText);
            total += isNaN(price) ? 0 : price;
        }
        console.log("TOTAL SERVICE:" + total);
        return total;
    }

    function formatCurrency(amount) {
        // Check if the input is a valid number
        if (isNaN(amount)) {
            return 'Invalid number';
        }

        // Convert the number to a string and split it into integer and decimal parts
        const parts = amount.toString().split('.');

        // Format the integer part with commas
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');

        // Join the parts and append 'VND'
        return parts.join('.') + ' VND';
    }

    function handleOnClickCheckout() {
        if (confirm("Bạn có muốn đổi trạng thái thành 'Đã checkout'")) {
            if (validateServicePrice() && isSurchargeIsAccept()) {
                $("#checkout-form").trigger("submit");
            }
        }
    }

    function isSurchargeIsAccept() {
        let $surcharge = $("#surcharge-price");
        let surchargePrice = $surcharge.val();
        if (Number(surchargePrice) >= 1000000000) {
            triggerToast("Thất bại", "Phụ phí không thể quá 1 tỷ VND, vui lòng giảm phụ phí")
            return false;
        }
        return true;
    }

    function extractNumberFromVND(vndString) {
        // Remove commas and any non-digit characters
        const numericString = vndString.replace(/[^\d]/g, '');

        // Convert the numeric string to a number
        return parseFloat(numericString);
    }

    /**Toast Function*/
    let timer1, timer2;
    const button = document.querySelector("button");
    const toast = document.querySelector(".toast-custom");
    const closeIcon = document.querySelector(".close");
    const progress = document.querySelector(".progress");
    const $title = document.querySelector("#toast-title");
    const $detail = document.querySelector("#toast-detail");

    function triggerToast(title, detail) {
        console.log("TRIGGER TOAST:");
        $title.textContent = title;
        $detail.textContent = detail;
        toast.classList.add("active");
        progress.classList.add("active");

        timer1 = setTimeout(() => {
            toast.classList.remove("active");
        }, 5000); //1s = 1000 milliseconds

        timer2 = setTimeout(() => {
            progress.classList.remove("active");
        }, 5300);
    }

    closeIcon.addEventListener("click", () => {
        toast.classList.remove("active");

        setTimeout(() => {
            progress.classList.remove("active");
        }, 300);

        clearTimeout(timer1);
        clearTimeout(timer2);
    });
</script>
</html>